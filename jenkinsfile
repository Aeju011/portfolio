pipeline {
  agent any

  environment {
    DEPLOY_DIR = 'C:\\inetpub\\wwwroot'
    GIT_CREDS  = 'github-aejaz'
  }

  stages {
    stage('Checkout') {
      steps {
        echo "Cloning project from GitHub with credentialsId=${env.GIT_CREDS}"
        git branch: 'master',
            url: 'https://github.com/Aeju011/portfolio.git',
            credentialsId: "${env.GIT_CREDS}"
      }
    }

    stage('Build - list workspace') {
      steps {
        bat """
          echo ===== Workspace: %WORKSPACE% =====
          echo User: %USERNAME%
          dir "%WORKSPACE%" /A
          if exist "%WORKSPACE%\\assets" ( echo assets folder present & dir "%WORKSPACE%\\assets" )
          if exist "%WORKSPACE%\\deploy.ps1" ( echo deploy.ps1 FOUND ) else ( echo deploy.ps1 NOT FOUND )
        """
      }
    }

    stage('Deploy') {
      steps {
        script {
          // prefer running deploy.ps1 if present
          if (fileExists("${env.WORKSPACE}\\deploy.ps1")) {
            echo "Found deploy.ps1 — invoking PowerShell"
            def rc = bat(script: "powershell -NoProfile -ExecutionPolicy Bypass -File \"%WORKSPACE%\\\\deploy.ps1\" -Workspace \"%WORKSPACE%\" -Dest \"${DEPLOY_DIR}\"", returnStatus: true)
            if (rc != 0) {
              error("deploy.ps1 failed (exit ${rc}). Check deploy.ps1 output and permissions for ${DEPLOY_DIR}.")
            }
          } else {
            echo "deploy.ps1 not found — using fallback copy"
            // ensure destination exists
            def rc = bat(script: "if not exist \"${DEPLOY_DIR}\" mkdir \"${DEPLOY_DIR}\"", returnStatus: true)
            if (rc != 0) {
              error("Unable to create destination ${DEPLOY_DIR} (exit ${rc}). Check permissions.")
            }

            // copy index.html
            def rcIndex = bat(script: "if exist \"%WORKSPACE%\\\\index.html\" ( xcopy /Y /Q \"%WORKSPACE%\\\\index.html\" \"${DEPLOY_DIR}\\\\\" ) else ( exit 2 )", returnStatus: true)
            if (rcIndex == 2) {
              echo "index.html not present in workspace"
            } else if (rcIndex != 0) {
              error("Failed to copy index.html (exit ${rcIndex}). Likely permission denied writing to ${DEPLOY_DIR}.")
            }

            // copy about.html
            def rcAbout = bat(script: "if exist \"%WORKSPACE%\\\\about.html\" ( xcopy /Y /Q \"%WORKSPACE%\\\\about.html\" \"${DEPLOY_DIR}\\\\\" ) else ( exit 2 )", returnStatus: true)
            if (rcAbout == 2) {
              echo "about.html not present in workspace"
            } else if (rcAbout != 0) {
              error("Failed to copy about.html (exit ${rcAbout}). Likely permission denied writing to ${DEPLOY_DIR}.")
            }

            // copy assets folder
            def rcAssets = bat(script: "if exist \"%WORKSPACE%\\\\assets\" ( xcopy /E /I /Y /Q \"%WORKSPACE%\\\\assets\" \"${DEPLOY_DIR}\\\\assets\\\\\" ) else ( exit 2 )", returnStatus: true)
            if (rcAssets == 2) {
              echo "assets folder not present"
            } else if (rcAssets != 0) {
              error("Failed to copy assets (exit ${rcAssets}). Likely permission denied writing to ${DEPLOY_DIR}.")
            }

            // make sure at least one artifact exists
            if (!(fileExists("${env.WORKSPACE}\\index.html") || fileExists("${env.WORKSPACE}\\about.html") || fileExists("${env.WORKSPACE}\\assets"))) {
              error("No deployable artifacts found (index.html or about.html or assets/).")
            }
          } // end fallback branch
        } // end script
      }
    }

    stage('Verify HTTP (server-side)') {
      steps {
        script {
          def rc = bat(script: "powershell -NoProfile -Command \"try { \$r = Invoke-WebRequest -UseBasicParsing -Uri 'https://localhost/index.html' -TimeoutSec 10; if (\$r.StatusCode -eq 200) { Write-Output 'HTTP_OK' } else { Write-Output 'HTTP_NON200'; exit 3 } } catch { Write-Output 'HTTP_ERROR'; exit 3 }\"", returnStatus: true)
          if (rc != 0) {
            error("HTTP verification failed (exit ${rc}). Check that IIS is running, site bindings and firewall allow port 80, and that files exist in ${DEPLOY_DIR}.")
          } else {
            echo "HTTP verification succeeded."
          }
        }
      }
    }
  }

  post {
    success {
      echo "Pipeline finished successfully. Visit: http://<jenkins-host-or-ip>/index.html"
    }
    failure {
      echo "Pipeline failed — check console output above. Common issues: wrong credentials, missing files, or no write permission to ${DEPLOY_DIR}."
    }
  }
}
